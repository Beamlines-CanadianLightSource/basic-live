"use strict";function getPrecision(t,e){e=e||8;let a=(t[t.length-1]-t[0])/e;return Math.abs(Math.floor(Math.log10(a.toPrecision(1))||2))}function renderMarkdown(t){return(new showdown.Converter).makeHtml(t)}const figureTypes=["histogram","lineplot","barchart","scatterplot","pie","gauge","timeline","columnchart","heatmap"];let ColorSchemes={Live4:["#8f9f9a","#c56052","#9f6dbf","#a0b552"],Live8:["#073B4C","#06D6A0","#FFD166","#EF476F","#118AB2","#7F7EFF","#afc765","#78C5E7"],Live16:["#67aec1","#c45a81","#cdc339","#ae8e6b","#6dc758","#a084b6","#667ccd","#cd4f55","#805cd6","#cf622d","#a69e4c","#9b9795","#6db586","#c255b6","#073B4C","#FFD166"],Dark2:d3.schemeDark2,Set1:d3.schemeSet1,Set2:d3.schemeSet2,Set3:d3.scheme,Tableau10:d3.schemeTableau10},styleTemplate=_.template("<%= selector %> { <%= rules %> }"),contentTemplate=_.template('<div id="entry-<%= id %>" <% let style = entry.style || ""; %> class="section-entry <%= style %>" >   <% if ((entry.title) &! (entry.kind))  { %>       <h4><%= entry.title %></h4>   <% } %>   <% if (entry.description) { %>       <div class="description"><%= renderMarkdown(entry.description) %></div>   <% } %>   <% if ((entry.kind === "table") && (entry.data)) { %>       <%= tableTemplate({id: id, entry: entry}) %>   <% } else if (figureTypes.includes(entry.kind)) { %>       <figure id="figure-<%= entry.id || id %>" data-type="<%= entry.kind %>" data-chart=\'<%= JSON.stringify(entry) %>\' >       </figure>   <% }%>   <% if (entry.notes) { %>       <div class="notes"><%= renderMarkdown(entry.notes) %></div>   <% } %></div>'),sectionTemplate=_.template('<section id="section-<%= id %>" <% let style = section.style || "col-12"; %>       class="<%= style %>">       <%  if (section.title)  {%>       <h3 class="section-title col-12"><%= section.title %></h3>       <% } %>       <%  if (section.description)  {%>       <div class="description"><%= renderMarkdown(section.description) %></div>       <% } %>     <% _.each(section.content, function(entry, j){ %><%= contentTemplate({id: id+"-"+j, entry: entry}) %><% }); %></section>'),tableTemplate=_.template('<table id="table-<%= id %>" class="table table-sm table-hover"><% if (entry.title) { %>   <caption class="text-center"><%= entry.title %></caption><% } %><% if (entry.header.includes("row")) { %>   <thead><tr>       <% _.each(entry.data[0], function(cell, i){ %>       <th><%= cell %></th>       <% }); %>   </tr></thead><% } %><tbody><% _.each(entry.data, function(row, j){ %>   <% if ((!entry.header.includes("row")) || (j>0)) { %>       <tr>       <% _.each(row, function(cell, i){ %>           <% if (entry.header.includes("column") && (i==0)) { %>               <th><%= cell %></th>           <% } else { %>               <td><%= cell %></td>           <% } %>       <% }); %>       </tr>   <% } %><% }); %></tbody></table>'),NUM_TICKS=10;function drawXYChart(t,e,a,n="spline"){let i=[],r=[],l={},d=n,o={interpolation:{}},s={x:{},y:{},y2:{}},c=[],h=e.data.x[1],p=e.data.x[e.data.x.length-1],y=d3.scaleLinear().domain([h,p]),u=y.ticks(NUM_TICKS),m=function(t){return t},f=function(t){return t},x=2;switch(e.data["x-scale"]){case"time":m=function(t){return Date.parse(t)},s.x=$.extend(s.x,{type:"timeseries",tick:{format:e.data["time-format"],culling:{max:13}}});break;case"pow":case"inv-square":let t="pow"===e.data["x-scale"]?1:-1;m=d3.scalePow().exponent(2*t).domain([h,p]),f=m.invert,y.domain([m(h),m(p)]),u=y.ticks(NUM_TICKS),x=getPrecision(u),s.x=$.extend(s.x,{tick:{values:u,multiline:!1,format:t=>f(t).toFixed(x)}});break;case"log":m=d3.scaleLog().domain([h,p]),f=m.invert,y.domain([m(h),m(p)]),u=y.ticks(NUM_TICKS),x=getPrecision(u),s.x=$.extend(s.x,{tick:{values:u,multiline:!1,format:t=>f(t).toFixed(x)}});break;case"identity":s.x=$.extend(s.x,{type:"index",tick:{multiline:!1}});break;default:s.x=$.extend(s.x,{tick:{values:u,fit:!0,multiline:!1,format:t=>f(t).toFixed(x)}})}e.data["x-limits"]&&(s.x=$.extend(s.x,{min:m(e.data["x-limits"][0]),max:m(e.data["x-limits"][1]),padding:0})),e.data["y1-limits"]&&(s.y=$.extend(s.y,{min:e.data["y1-limits"][0],max:e.data["y1-limits"][1],padding:0})),e.data["y2-limits"]&&(s.y2=$.extend(s.y2,{min:e.data["y2-limits"][0],max:e.data["y2-limits"][1],padding:0})),["cardinal","basis","step","step-before","step-after"].includes(e.data.interpolation)&&(d="spline",o.interpolation.type=e.data.interpolation),$.each(e.data.x,(function(t,e){0===t?c.push(e):c.push(m(e))})),s.x.label=e.data["x-label"]||e.data.x[0],r.push(c),t.removeData("chart").removeAttr("data-chart"),$.each(e.data.y1,(function(t,a){r.push(a),l[a[0]]="y",i.push(a[0]),0===t&&(s.y.label=e.data["y1-label"]||a[0])})),$.each(e.data.y2,(function(t,a){r.push(a),l[a[0]]="y2",i.push(a[0]),s.y2.show=!0,0===t&&(s.y2.label=e.data["y2-label"]||a[0])}));let g=d3.scaleOrdinal().domain(i).range(a.scheme);$.each(i,(function(t,e){e in a.colors||(a.colors[e]=g(e))}));let w=c3.generate({bindto:`#${t.attr("id")}`,size:{width:a.width,height:a.height},data:{type:d,columns:r,colors:a.colors,axes:l,x:e.data.x[0]},spline:o,point:{show:e.data.x.length<15},axis:s,grid:{y:{show:!0}},onresize:function(){this.api.resize({width:t.width(),height:t.width()*a.height/a.width})}});e.data.annotations&&w.xgrids(e.data.annotations),t.data("c3-chart",w)}function drawBarChart(t,e,a){let n=[],i=[],r=[],l=("object"==typeof e.data.colors&&e.data.colors,function(t,e){return t});t.removeData("chart"),t.removeAttr("data-chart");if($.each(e.data.data[0],(function(t,a){t===e.data["color-by"]?r.push(t):t===e.data["x-label"]||n.push(t)})),e.data["color-by"]){let t=e.data["color-by"];$.each(e.data.data,(function(e,a){i.includes(a[t])||i.push(a[t])})),l=function(n,i){if("object"==typeof i){let n=e.data.data[i.index][t];return a.colors[n]}return n}}let d=d3.scaleOrdinal().domain(i.concat(n)).range(a.scheme);$.each(n,(function(t,e){e in a.colors||(a.colors[e]=d(e))}));let o={},s={},c={show:!!e.data.line,label:e.data.line};e.data.line&&(s[e.data.line]="line",o[e.data.line]="y2",e.data["line-limits"]&&(c=$.extend(c,{min:e.data["line-limits"][0],max:e.data["line-limits"][1],padding:0})));let h=c3.generate({bindto:`#${t.attr("id")}`,size:{width:a.width,height:a.height},data:{type:"bar",json:e.data.data,hide:r,color:l,colors:a.colors,keys:{x:e.data["x-label"],value:n},axes:e.data.line&&o||{},types:e.data.line&&s||{},groups:e.data.stack||[],order:null},grid:{y:{show:!0}},axis:{x:{type:"category",label:e.data["x-label"]},y2:c,rotated:a.horizontal||!1},legend:{hide:1===n.length},bar:{width:{ratio:.6}},padding:{bottom:20},onresize:function(){this.api.resize({width:t.width(),height:t.width()*a.height/a.width})}});e.data.annotations&&(a.horizontal?h.ygrids(e.data.annotations):h.xgrids(e.data.annotations)),t.data("c3-chart",h)}function drawHistogram(t,e,a){let n=e["y-scale"],i=e.data.data;t.removeData("chart"),t.removeAttr("data-chart");let r=c3.generate({bindto:`#${t.attr("id")}`,size:{width:a.width,height:a.height},data:{type:"bar",json:i,colors:{y:a.scheme[t.parent().index()]},keys:{x:"x",value:["y"]}},axis:{x:{tick:{fit:!1,count:10,format:t=>t.toFixed(1)}},y:{type:n}},legend:{hide:!0},grid:{y:{show:!0}},bar:{width:{ratio:.5}},onresize:function(){this.api.resize({width:t.width(),height:t.width()*a.height/a.width})}});t.data("c3-chart",r)}function drawPieChart(t,e,a){let n={},i=[],r={};t.removeData("chart"),t.removeAttr("data-chart"),$.each(e.data.data,(function(t,e){n[e.label]=e.value,i.push(e.label),r[e.label]=e.color||a.scheme[t]}));let l=c3.generate({bindto:`#${t.attr("id")}`,size:{width:a.width,height:a.height},data:{type:"pie",json:[n],colors:r,keys:{value:i}},onresize:function(){this.api.resize({width:t.width(),height:t.width()*a.height/a.width})}});t.data("c3-chart",l)}function drawScatterChart(t,e,a){drawXYChart(t,e,a,"scatter")}function drawLineChart(t,e,a){drawXYChart(t,e,a,"line")}function callout(t,e,a){if(!e)return t.style("display","none");t.attr("data-label")&&(e=`${e} - ${t.attr("data-label")}`),t.attr("data-label"),t.style("display",null).style("pointer-events","none").style("font","10px sans-serif");const n=t.selectAll("path").data([null]).join("path").attr("fill","var(--warning)").attr("stroke","black"),i=t.selectAll("text").data([null]).join("text").call((t=>t.selectAll("tspan").data((e+"").split(/\n/)).join("tspan").attr("x",0).attr("y",((t,e)=>1.1*e+"rem")).style("font-weight",((t,e)=>e?null:"bold")).text((t=>t)))),{x:r,y:l,width:d,height:o}=i.node().getBBox();i.attr("transform",`translate(${-d/2},${10-l})`),n.attr("d",`M${-d/2-10},5H-5l5,-5l5,5H${d/2+10}v${o+10}h-${d+20}z`)}function drawTimeline(t,e,a){let n=[],i=10,r=10,l=10,d=10,o=a.width-d-r,s=o/2;$.each(e.data,(function(t,e){n.includes(e.type)||n.push(e.type)})),n.sort();let c=d3.scaleOrdinal().domain(n).range(a.scheme),h=d3.timeline().size([o,150]).extent([e.start,e.end]).bandStart((t=>t.start)).bandEnd((t=>t.end)).padding(2)(e.data),p=d3.scaleLinear().domain([e.start,e.end]).range([0,o]),y=d3.axisBottom().scale(p).tickFormat(d3.timeFormat("%H:%M")),u=d3.select(`#${t.attr("id")}`).append("svg").attr("viewBox",`-${d} -${i} ${a.width} 240`).attr("class","w-100");u.selectAll("rect.event").data(h).enter().append("rect").attr("class","event").attr("x",(function(t){return t.start})).attr("x",(function(t){return t.start})).attr("y",(function(t){return t.y})).attr("height",(function(t){return t.dy})).attr("width",(function(t){return t.end-t.start})).attr("data-label",(t=>`${t.label}`)).attr("data-type",(t=>t.type)).attr("shape-rendering","geometricPrecision").style("fill",(t=>c(t.type))).style("stroke",(t=>c(t.type))).attr("pointer-events","all").on("mouseover",(function(){b.attr("data-label",$(this).data("label"))})).on("mouseout",(function(){b.attr("data-label",null)})),u.append("g").call(y).attr("transform","translate(0, 160)");let m=0,f=u.append("g"),x=f.selectAll(".legend").data(n).enter().append("g").attr("class","legend").attr("data-type",(function(t,e){return t})).attr("transform",(function(t,e){if(0===e)return m=t.length+80,"translate(0,0)";{let e=m;return m+=t.length+80,`translate(${e}, 0)`}})).on("mouseover",(function(){let t=$(this).data("type");u.selectAll(`rect.event:not([data-type="${t}"])`).style("opacity",.1)})).on("mouseout",(function(){u.selectAll("rect").style("opacity",1)}));x.append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).style("fill",(t=>c(t))),x.append("text").attr("x",20).attr("y",10).text((function(t,e){return t})).style("text-anchor","start").style("font-size","10");let g=s-m/2,w=240-l-30;f.attr("transform",`translate(${g}, ${w})`);const b=u.append("g");u.append("g").attr("class","mouse-cursor").append("path").attr("class","mouse-line").style("stroke","var(--warning)").style("stroke-width","1px").style("opacity","0").attr("pointer-events","none");u.on("mouseleave",(function(){d3.select(".mouse-line").style("opacity",0),b.call(callout,null)})).on("touchmove mousemove",(function(){const t=d3.mouse(this),e=d3.timeFormat("%H:%M %b %d, %Y")(p.invert(t[0]));t[1]<165?(d3.select(".mouse-line").style("opacity",1).attr("d",(function(){return`M ${t[0]}, 160, ${t[0]} 0`})),b.attr("transform",`translate(${t[0]}, 164)`).call(callout,e)):(d3.select(".mouse-line").style("opacity",0),b.call(callout,null))})),t.removeData("chart").removeAttr("data-chart"),window.onresize=function(){let e=o/t.width();u.selectAll("text").attr("transform",`scale(${e} ${e})`),u.selectAll("line").attr("stroke-width",`${e}px`)}}function getUnique(t){let e=t.map((t=>t.toFixed(3)));return[...new Set(e)]}function drawHeatMap(t,e,a){let n=20,i=20,r=35,l=40,d=a.width-l-i,o=a.height-r-n,s=e.data.x.shift(),c=e.data.y.shift(),h=e.data.z.map(((t,e)=>t.shift())),p=d3.range(h.length);void 0!==e.data.selected&&(p=d3.range(h.length).filter(((t,a)=>e.data.selected.indexOf(t))));let y=d3.range(e.data.x.length).map((t=>p.reduce(((a,n)=>a+e.data.z[n][t]),0)/p.length)),u=d3.min(e.data.x),m=d3.max(e.data.x),f=d3.min(e.data.y),x=d3.max(e.data.y);const g="11px Fira Code";let w=e.data.x.map(((t,a)=>({x:t,y:e.data.y[a],z:y[a]}))),b=d3.scaleOrdinal().domain(h).range(a.scheme),v=d3.scaleQuantile().domain([d3.min(y),d3.max(y)]).range(d3.range(0,1.002,.002)),k=t=>{let e=t.length,a=t.map((t=>w.find((e=>e.x==t.x&&e.y==t.y)).z)).reduce(((t,e)=>t+e));return v(a/e)},C=getUnique(e.data.x).length,z=getUnique(e.data.y).length,A=1.25*d3.max([d/((C+.5)*Math.sqrt(3)),o/(1.5*(z+1/3))]),F=d3.scaleLinear().domain([u,m]).rangeRound([d,0]),M=d3.scaleLinear().domain([f,x]).rangeRound([o,0]);const S=d3.hexbin().x((t=>F(t.x))).y((t=>M(t.y))).radius(A).extent([[0,0],[d,o]]);let T=d3.scaleLinear().domain([x,f]).range([o,0]),j=d3.axisLeft().scale(T).ticks(15),L=d3.scaleLinear().domain([m,u]).range([0,d]),B=d3.axisBottom().scale(L).ticks(15),_=d3.select(`#${t.attr("id")}`).append("svg").attr("viewBox",`-${l} -${n} ${d+l+i} ${o+n+r}`).attr("class","w-100"),D=d3.range(e.data.x.length).map(((t,a)=>({x:e.data.x[a],y:e.data.y[a]}))),H=S(D),O=d3.select(`#${t.attr("id")}`).append("div").style("opacity",0).attr("class","tooltip").style("background-color","white").style("border","solid").style("border-width","2px").style("border-radius","5px").style("padding","5px"),P=_.append("g").selectAll("path").data(H).join("path").attr("d",S.hexagon()).attr("transform",(t=>`translate(${t.x},${t.y})`)).attr("data-label",((t,e)=>`${D[e].x}, ${D[e].y} : ${y[e]}`)).style("fill",(function(t){return d3.interpolateViridis(k(t))})).on("mouseover",(function(t){O.style("opacity",1)})).on("mousemove",(function(t,e){O.html(`(x, y) = (${t[0].x.toFixed(3)}, ${-1*t[0].y.toFixed(3)})`).style("left",d3.mouse(this)[0]+t.x+l+"px").style("top",d3.mouse(this)[1]+t.y+r+"px")})).on("mouseleave",(function(t){O.style("opacity",0)}));_.append("g").attr("transform",`translate(0, ${o})`).style("font",g).call(B),_.append("text").attr("transform","translate("+(d-i)+" ,"+(o+n+10)+")").style("text-anchor","middle").style("font",g).text(s),_.append("g").call(j),_.append("text").attr("transform","rotate(-90)").attr("y",0-l).attr("x",0-n).attr("dy","1em").style("text-anchor","middle").style("font",g).text(c);let U=0,q=_.append("g"),N=q.selectAll(".legend").data(h).enter().append("g").attr("class","legend").attr("data-type",(function(t,e){return t})).attr("transform",(function(t,e){if(0===e)return U=t.length+50,"translate(0,0)";{let e=U;return U+=t.length+50,`translate(${e}, 0)`}})).on("click",(function(){let t=$(this).data("type"),a=h.indexOf(t);if(-1!==p.indexOf(a)){if(1==p.length)return;p=p.filter(((t,e)=>t!==a)),_.selectAll(`rect[data-type="${t}"]`).style("opacity",.1)}else p.push(h.indexOf(t)),_.selectAll(`rect[data-type="${t}"]`).style("opacity",1);let n=p.length;y=d3.range(e.data.x.length).map((t=>p.reduce(((a,n)=>a+e.data.z[n][t]),0)/n)),console.log(d3.max(y),p),v=d3.scaleQuantile().domain([d3.min(y),d3.max(y)]).range(d3.range(0,1.002,.002)),w=e.data.x.map(((t,a)=>({x:t,y:e.data.y[a],z:y[a]}))),P.style("fill",(function(t){return d3.interpolateViridis(k(t))}))}));N.append("rect").attr("x",0).attr("y",0).attr("width",12).attr("height",12).attr("data-type",(function(t,e){return t})).style("fill",(t=>b(t))),N.append("text").attr("x",22).attr("y",12).text((function(t,e){return t})).style("text-anchor","start").style("font",g);let E=d/2-50*h.length/2,I=o+n;q.attr("transform",`translate(${E}, ${I})`)}!function(t){t.fn.liveReport=function(e){let a=t(this),n=t.extend({data:{}},e);a.addClass("report-viewer"),t.each(n.data.details,(function(t,e){a.append(sectionTemplate({id:t,section:e}))})),a.find("figure").each((function(){let e=t(this),a=e.data("chart"),n={width:e.width(),height:e.width()/(a.data["aspect-ratio"]||16/9),colors:{}};switch(Array.isArray(a.data.colors)?n.scheme=a.data.colors:"object"==typeof a.data.colors?(n.scheme=ColorSchemes.Live16,n.colors=a.data.colors):n.scheme=ColorSchemes[a.data.colors]||ColorSchemes.Live16,e.data("type")){case"barchart":n.horizontal=!0,drawBarChart(e,a,n);break;case"columnchart":drawBarChart(e,a,n);break;case"lineplot":drawLineChart(e,a,n);break;case"histogram":drawHistogram(e,a,n);break;case"pie":drawPieChart(e,a,n);break;case"scatterplot":drawScatterChart(e,a,n);break;case"timeline":drawTimeline(e,a,n);break;case"heatmap":drawHeatMap(e,a,n)}a.title?e.after(`<figcaption class="text-center">${a.title}</figcaption>`):e.after('<figcaption class="text-center"></figcaption>')}))}}(jQuery);